<div id="comentarios-loading" style="text-align:center; font-style:italic; color:#ccc; margin:20px 0;">
    Carregando coment√°rios...
</div>

<div id="comentarios-container" class="comentarios-container" style="display:none;">
    <h2>üí¨ Coment√°rios</h2>

    <div class="reacoes">
        <button class="reacao" data-reacao="üëç">üëç <span id="like-count">0</span></button>
        <button class="reacao" data-reacao="‚ù§Ô∏è">‚ù§Ô∏è <span id="love-count">0</span></button>
        <button class="reacao" data-reacao="üòÇ">üòÇ <span id="laugh-count">0</span></button>
        <button class="reacao" data-reacao="üòÆ">üòÆ <span id="wow-count">0</span></button>
        <button class="reacao" data-reacao="üò¢">üò¢ <span id="sad-count">0</span></button>
        <button class="reacao" data-reacao="üò°">üò° <span id="angry-count">0</span></button>
    </div>

    <form id="comentario-form">
        <input type="text" id="nome" placeholder="Seu nome">
        <input type="email" id="email" placeholder="Seu email (avatar)">
        <textarea id="comentario" placeholder="Escreva seu coment√°rio"></textarea>
        <button type="submit">Enviar</button>
    </form>

    <div id="comentarios-list"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbxt2_JLXL9jyl2NDr_uPnZ26zcED95LFCt9z6pt1Gv8FcGsXw2S0LsiUzr2s2nnw3Pvwg/exec";
const urlPagina = window.location.pathname;

// Gravatar
function getGravatar(email) {
    if(!email) return "https://www.gravatar.com/avatar/?d=identicon&s=50";
    const hash = md5(email.trim().toLowerCase());
    return `https://www.gravatar.com/avatar/${hash}?d=identicon&s=50`;
}

// Enviar coment√°rio ou resposta
async function enviarComentario(nome, email, texto, parentId="") {
    if(!texto.trim()) return;
    await fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify({ url: urlPagina, nome: nome||"An√¥nimo", email: email||"", comentario:texto, reacao:"", parentId })
    });
    carregarComentarios(); // Atualiza somente ap√≥s envio
}

// Criar formul√°rio de resposta
function criarFormularioResposta(parentDiv,parentId){
    if(parentDiv.querySelector(".resposta-form")) return;
    const form = document.createElement("div");
    form.className="resposta-form";
    form.style.marginTop="10px";
    form.innerHTML=`
        <input type="text" placeholder="Seu nome" class="resposta-nome">
        <input type="email" placeholder="Seu email (avatar)" class="resposta-email">
        <textarea placeholder="Escreva sua resposta" class="resposta-texto"></textarea>
        <button class="resposta-btn">Enviar</button>
    `;
    parentDiv.appendChild(form);
    form.querySelector(".resposta-btn").addEventListener("click",()=>{
        const nome=form.querySelector(".resposta-nome").value;
        const email=form.querySelector(".resposta-email").value;
        const texto=form.querySelector(".resposta-texto").value;
        enviarComentario(nome,email,texto,parentId);
        form.remove();
    });
}

// Formul√°rio principal
const formPrincipal = document.getElementById("comentario-form");
formPrincipal.addEventListener("submit",(e)=>{
    e.preventDefault();
    const nome=formPrincipal.querySelector("#nome").value;
    const email=formPrincipal.querySelector("#email").value;
    const texto=formPrincipal.querySelector("#comentario").value;
    formPrincipal.querySelector("#comentario").value="";
    enviarComentario(nome,email,texto);
});

// Rea√ß√µes
document.querySelectorAll(".reacao").forEach(btn=>{
    btn.addEventListener("click",()=>{
        const reacao = btn.getAttribute("data-reacao");
        fetch(scriptURL,{method:"POST",body:JSON.stringify({url:urlPagina,nome:"An√¥nimo",comentario:"",reacao,parentId:""})})
        .then(()=>carregarComentarios());
    });
});

// Carregar coment√°rios
async function carregarComentarios(){
    const loading = document.getElementById("comentarios-loading");
    const container = document.getElementById("comentarios-container");
    loading.style.display="block";
    container.style.display="none";

    try{
        const res = await fetch(`${scriptURL}?url=${encodeURIComponent(urlPagina)}`);
        const dados = await res.json();
        const lista = document.getElementById("comentarios-list");
        lista.innerHTML="";

        const comentariosPrincipais = dados.comentarios.filter(c=>!c.parentId);
        const respostas = dados.comentarios.filter(c=>c.parentId);

        comentariosPrincipais.forEach(c=>{
            const div=document.createElement("div");
            div.className="comentario-item";
            div.innerHTML=`
                <img src="${getGravatar(c.email)}" alt="Avatar" class="avatar">
                <strong>${c.nome}</strong>
                <em>(${new Date(c.data).toLocaleString()})</em><br>
                ${c.comentario}<br>
                <button class="responder-btn">Responder</button>
            `;
            const divRespostas=document.createElement("div");
            divRespostas.style.marginLeft="40px";
            respostas.filter(r=>r.parentId===c.id).forEach(r=>{
                const rDiv=document.createElement("div");
                rDiv.className="comentario-resposta";
                rDiv.innerHTML=`
                    <img src="${getGravatar(r.email)}" alt="Avatar" class="avatar">
                    <strong>${r.nome}</strong>
                    <em>(${new Date(r.data).toLocaleString()})</em><br>
                    ${r.comentario}
                `;
                divRespostas.appendChild(rDiv);
            });
            div.appendChild(divRespostas);
            div.querySelector(".responder-btn").addEventListener("click",()=>criarFormularioResposta(div,c.id));
            lista.appendChild(div);
        });

        // Atualizar rea√ß√µes
        const emojiMap = { "üëç":"like-count","‚ù§Ô∏è":"love-count","üòÇ":"laugh-count","üòÆ":"wow-count","üò¢":"sad-count","üò°":"angry-count" };
        for(const emoji in emojiMap){
            const span=document.getElementById(emojiMap[emoji]);
            if(span) span.textContent=dados.reacoes[emoji]||0;
        }

    }catch(e){ console.error(e); }
    finally{
        loading.style.display="none";
        container.style.display="block";
    }
}

// Primeira carga
carregarComentarios(); // Carrega s√≥ no in√≠cio, depois s√≥ ao enviar coment√°rio ou resposta
</script>



<style>
.comentarios-container { max-width:600px; margin:30px auto; background:#1e1e1e; padding:20px; border-radius:12px; color:#f1f1f1; font-family: "Segoe UI",sans-serif; box-shadow:0 4px 10px rgba(0,0,0,0.4);}
.comentarios-container h2 {text-align:center; margin-bottom:15px; color:#ffcc00;}
.reacoes{display:flex; justify-content:center; flex-wrap:wrap; gap:12px; margin-bottom:20px;}
.reacao{background:#2a2a2a; border:none; padding:10px 18px; border-radius:20px; color:#fff; font-size:18px; cursor:pointer; transition:0.2s;}
.reacao:hover{background:#444; transform:scale(1.1);}
.reacao span{font-weight:bold; margin-left:6px; color:#ffcc00;}
#comentario-form, .resposta-form{display:flex; flex-direction:column; gap:10px; margin-bottom:10px;}
#comentario-form input, #comentario-form textarea, .resposta-form input, .resposta-form textarea{padding:8px; border-radius:6px; border:1px solid #555; background:#2a2a2a; color:#f1f1f1; font-size:14px;}
#comentario-form button, .resposta-btn{background:#ffcc00; color:#000; padding:8px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; transition:0.3s;}
#comentario-form button:hover, .resposta-btn:hover{background:#ffaa00;}
.comentario-item, .comentario-resposta{padding:8px; border-bottom:1px solid #333; margin-bottom:6px;}
.avatar{width:40px; height:40px; border-radius:50%; vertical-align:middle; margin-right:6px;}
</style>
